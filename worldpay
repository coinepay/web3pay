
<?php

class worldpay_plugin
{
    static public $info = [
        'name'        => 'worldpay', //æ”¯ä»˜æ’ä»¶è‹±æ–‡åç§°ï¼Œéœ€å’Œç›®å½•åç§°ä¸€è‡´ï¼Œä¸èƒ½æœ‰é‡å¤
        'showname'    => 'WorldPay TRXé’±åŒ…', //æ”¯ä»˜æ’ä»¶æ˜¾ç¤ºåç§°
        'author'      => 'WorldPay', //æ”¯ä»˜æ’ä»¶ä½œè€…
        'link'        => 'https://www.worldpay.im/', //æ”¯ä»˜æ’ä»¶ä½œè€…é“¾æ¥
        'types'       => ['usdt'], //æ”¯ä»˜æ’ä»¶æ”¯æŒçš„æ”¯ä»˜æ–¹å¼ï¼ŒUSDT-TRC20
        'inputs' => [ //æ”¯ä»˜æ’ä»¶è¦æ±‚ä¼ å…¥çš„å‚æ•°
            'appid' => [
                'name' => 'App ID',
                'type' => 'input',
                'note' => 'WorldPayåˆ†é…çš„åº”ç”¨ID',
            ],
            'appsecret' => [
                'name' => 'Secret Key',
                'type' => 'input',
                'note' => 'WorldPayåˆ†é…çš„å¯†é’¥',
            ],
            'appurl' => [
                'name' => 'APIåœ°å€',
                'type' => 'input',
                'note' => 'é»˜è®¤: https://admin.worldpay.im/client-api',
            ],
        ],
        'select' => null,
        'note' => 'WorldPay Web3é’±åŒ…ç³»ç»Ÿï¼Œæ”¯æŒTRXç½‘ç»œUSDTæ”¶æ¬¾ã€‚éœ€è¦å…ˆåœ¨WorldPayå¹³å°æ³¨å†Œå¹¶è·å–APIå¯†é’¥ã€‚', //æ”¯ä»˜å¯†é’¥å¡«å†™è¯´æ˜
        'bindwxmp' => false, //æ˜¯å¦æ”¯æŒç»‘å®šå¾®ä¿¡å…¬ä¼—å·
        'bindwxa' => false, //æ˜¯å¦æ”¯æŒç»‘å®šå¾®ä¿¡å°ç¨‹åº
    ];

    // è‡ªåŠ¨æ³¨å†Œæ’ä»¶åˆ°æ•°æ®åº“
    static public function install() {
        global $DB;
        
        $info = self::$info;
        $existing = $DB->getRow("SELECT * FROM pre_plugin WHERE name='{$info['name']}'");
        
        if (!$existing) {
            $DB->exec("INSERT INTO pre_plugin (name, showname, author, link, types) VALUES (?, ?, ?, ?, ?)", [
                $info['name'],
                $info['showname'], 
                $info['author'],
                $info['link'],
                implode(',', $info['types'])
            ]);
        }
    }

    static public function submit(){
        global $siteurl, $channel, $order, $ordername, $sitename;
        
        // æ·»åŠ è°ƒè¯•æ—¥å¿—
        error_log("WorldPay Plugin - submit() method called");
        error_log("WorldPay Plugin - Trade No: " . TRADE_NO);
        error_log("WorldPay Plugin - Channel: " . print_r($channel, true));
        
        // ä½¿ç”¨å›ºå®šçš„TRXåœ°å€ï¼Œä¸ç”¨æ¯æ¬¡åˆ›å»º
        $trx_address = "TZ7LVzNNCfxTk7vz6TwAwtBFHvWYBUVvMo";
        
        // å°†è®¢å•å·ä¿å­˜åˆ°è®¢å•å¤‡æ³¨ä¸­ï¼Œç”¨äºå›è°ƒåŒ¹é…
        global $DB;
        $DB->exec("UPDATE pre_order SET param=:trade_no WHERE trade_no=:trade_no", [
            ':trade_no' => TRADE_NO,
            ':trade_no' => TRADE_NO
        ]);
        
        error_log("WorldPay Plugin - Using fixed address: " . $trx_address);
        error_log("WorldPay Plugin - Order: " . TRADE_NO);
        
        // æ¸…ç©ºè¾“å‡ºç¼“å†²åŒºå¹¶ç›´æ¥è¾“å‡ºHTML
        ob_clean();
        header("Content-Type: text/html; charset=UTF-8");
        
        // ç›´æ¥è¾“å‡ºæ”¯ä»˜é¡µé¢HTML
        ?>
        <!DOCTYPE html>
        <html lang="zh-CN">
        <head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>TRX-USDTæ”¯ä»˜</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; text-align: center; background: #f5f5f5; }
                .container { max-width: 500px; margin: 0 auto; padding: 30px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                .header { margin-bottom: 30px; }
                .amount { font-size: 28px; color: #e74c3c; margin: 20px 0; font-weight: bold; }
                .address { background: #f8f9fa; padding: 20px; margin: 20px 0; word-break: break-all; font-family: monospace; border-radius: 8px; border: 2px solid #007bff; }
                .qr-code { margin: 20px 0; padding: 20px; background: white; border: 1px solid #ddd; border-radius: 10px; display: inline-block; }
                .warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; margin: 20px 0; border-radius: 8px; }
                button { padding: 12px 24px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
                button:hover { background: #0056b3; }
                .network-badge { background: #28a745; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; margin-left: 10px; }
                .status { margin-top: 20px; padding: 10px; border-radius: 5px; }
                .status.loading { background: #d1ecf1; color: #0c5460; }
                .status.success { background: #d4edda; color: #155724; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h2>ğŸ”— TRXç½‘ç»œ USDTæ”¯ä»˜</h2>
                    <p>è®¢å•å·: <?php echo TRADE_NO; ?></p>
                </div>
                
                <div class="amount">
                    æ”¯ä»˜é‡‘é¢: <?php echo $order['money']; ?> USDT
                    <span class="network-badge">TRC20</span>
                </div>
                
                <div class="qr-code" id="qrcode"></div>
                
                <div class="address">
                    <strong>ğŸ¦ æ”¶æ¬¾åœ°å€:</strong><br>
                    <div id="trx-address" style="margin-top: 10px; font-size: 14px;"><?php echo $trx_address; ?></div>
                </div>
                
                <button onclick="copyAddress()">ğŸ“‹ å¤åˆ¶åœ°å€</button>
                <button onclick="checkPayment()">ğŸ” æ£€æŸ¥æ”¯ä»˜çŠ¶æ€</button>
                
                <div class="warning">
                    <strong>âš ï¸ é‡è¦æé†’:</strong><br>
                    â€¢ è¯·ä½¿ç”¨ <strong>TRC20ç½‘ç»œ</strong> è½¬è´¦USDT<br>
                    â€¢ è½¬è´¦é‡‘é¢: <strong><?php echo $order['money']; ?> USDT</strong><br>
                    â€¢ è¯·å‹¿ä½¿ç”¨äº¤æ˜“æ‰€ç›´æ¥æå¸<br>
                    â€¢ è½¬è´¦ç¡®è®¤åçº¦1-3åˆ†é’Ÿåˆ°è´¦
                </div>
                
                <div id="status" class="status" style="display: none;"></div>
            </div>

            <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
            <script>
                // ç­‰å¾…é¡µé¢åŠ è½½å®Œæˆåç”ŸæˆäºŒç»´ç 
                document.addEventListener('DOMContentLoaded', function() {
                    const qrContainer = document.getElementById('qrcode');
                    
                    // æ£€æŸ¥QRCodeåº“æ˜¯å¦åŠ è½½æˆåŠŸ
                    if (typeof QRCode !== 'undefined') {
                        QRCode.toCanvas(qrContainer, '<?php echo $trx_address; ?>', {
                            width: 200,
                            height: 200,
                            colorDark: '#000000',
                            colorLight: '#ffffff'
                        }, function(error) {
                            if (error) {
                                console.error('QRç ç”Ÿæˆå¤±è´¥:', error);
                                qrContainer.innerHTML = '<p style="color: red;">äºŒç»´ç ç”Ÿæˆå¤±è´¥</p>';
                            }
                        });
                    } else {
                        // å¦‚æœQRCodeåº“åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ
                        console.log('QRCodeåº“æœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                        qrContainer.innerHTML = '<img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent('<?php echo $trx_address; ?>') + '" alt="TRXåœ°å€äºŒç»´ç " style="border: 1px solid #ddd;">';
                    }
                });

                // å¤åˆ¶åœ°å€
                function copyAddress() {
                    const address = document.getElementById('trx-address').textContent;
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(address).then(function() {
                            alert('âœ… åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                        });
                    } else {
                        const textArea = document.createElement('textarea');
                        textArea.value = address;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('âœ… åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    }
                }

                // æ£€æŸ¥æ”¯ä»˜çŠ¶æ€
                function checkPayment() {
                    const statusDiv = document.getElementById('status');
                    statusDiv.style.display = 'block';
                    statusDiv.className = 'status loading';
                    statusDiv.innerHTML = 'ğŸ”„ æ­£åœ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€...';
                    
                    fetch('/api.php?act=order&trade_no=<?php echo TRADE_NO; ?>')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 1 && data.status === '1') {
                                statusDiv.className = 'status success';
                                statusDiv.innerHTML = 'âœ… æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨è·³è½¬...';
                                setTimeout(function() {
                                    window.location.href = '<?php echo $order['return_url'] ?: '/'; ?>';
                                }, 2000);
                            } else {
                                statusDiv.className = 'status';
                                statusDiv.innerHTML = 'â³ æ”¯ä»˜å°šæœªå®Œæˆï¼Œè¯·ç¡®è®¤è½¬è´¦åå†æ¬¡æ£€æŸ¥';
                            }
                        })
                        .catch(error => {
                            statusDiv.className = 'status';
                            statusDiv.innerHTML = 'âŒ æ£€æŸ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
                        });
                }

                // è‡ªåŠ¨æ£€æŸ¥æ”¯ä»˜çŠ¶æ€ï¼ˆæ¯10ç§’ï¼‰
                setInterval(function() {
                    fetch('/api.php?act=order&trade_no=<?php echo TRADE_NO; ?>')
                        .then(response => response.json())
                        .then(data => {
                            if (data.code === 1 && data.status === '1') {
                                const statusDiv = document.getElementById('status');
                                statusDiv.style.display = 'block';
                                statusDiv.className = 'status success';
                                statusDiv.innerHTML = 'âœ… æ”¯ä»˜æˆåŠŸï¼æ­£åœ¨è·³è½¬...';
                                setTimeout(function() {
                                    window.location.href = '<?php echo $order['return_url'] ?: '/'; ?>';
                                }, 2000);
                            }
                        });
                }, 10000);
            </script>
        </body>
        </html>
        <?php
        exit(0);
        
        /*
        // åŸæ¥çš„APIè°ƒç”¨ä»£ç ï¼ˆæš‚æ—¶æ³¨é‡Šï¼‰
        try {
            // åˆ›å»ºTRXé’±åŒ…åœ°å€
            $walletData = self::createTRXWallet();
            
            if (!$walletData || !isset($walletData['address'])) {
                throw new Exception('åˆ›å»ºé’±åŒ…åœ°å€å¤±è´¥');
            }
            
            $trx_address = $walletData['address'];
            
            // å°†é’±åŒ…åœ°å€ä¿å­˜åˆ°è®¢å•å¤‡æ³¨ä¸­ï¼Œç”¨äºåç»­å›è°ƒåŒ¹é…
            global $DB;
            $DB->exec("UPDATE pre_order SET param=:address WHERE trade_no=:trade_no", [
                ':address' => $trx_address,
                ':trade_no' => TRADE_NO
            ]);
            
            // è®°å½•è°ƒè¯•ä¿¡æ¯
            error_log("WorldPay Plugin - TRX Address: " . $trx_address);
            error_log("WorldPay Plugin - Returning page result");
            
            // è¿”å›æ”¯ä»˜é¡µé¢ï¼Œæ˜¾ç¤ºTRXåœ°å€å’ŒäºŒç»´ç 
            return [
                'type' => 'page',
                'page' => 'worldpay_test',
                'data' => ['code_url' => $trx_address]
            ];
            
        } catch (Exception $e) {
            error_log("WorldPay Plugin - Error: " . $e->getMessage());
            return [
                'type' => 'error',
                'msg' => 'åˆ›å»ºæ”¯ä»˜åœ°å€å¤±è´¥: ' . $e->getMessage()
            ];
        }
        */
    }

    static public function notify(){
        global $DB, $channel, $order, $conf;
        
        // è®°å½•è°ƒè¯•ä¿¡æ¯
        error_log("WorldPay Webhook - notify() called");
        error_log("WorldPay Webhook - Headers: " . json_encode(getallheaders()));
        
        // è·å–Webhookæ•°æ®
        $input = file_get_contents('php://input');
        error_log("WorldPay Webhook - Raw input: " . $input);
        
        $data = json_decode($input, true);
        
        if (!$data) {
            error_log("WorldPay Webhook - Invalid JSON data");
            http_response_code(400);
            echo 'INVALID_JSON';
            exit;
        }
        
        error_log("WorldPay Webhook - Parsed data: " . json_encode($data));
        
        // æ ¹æ®åœ°å€å…ˆæŸ¥æ‰¾è®¢å•ï¼Œè·å–å¯¹åº”çš„é€šé“é…ç½®
        if (!isset($data['walletAddress'])) {
            error_log("WorldPay Webhook - No walletAddress in data");
            http_response_code(400);
            echo 'NO_ADDRESS';
            exit;
        }
        
        $address = $data['walletAddress'];
        error_log("WorldPay Webhook - Looking for address: " . $address);
        
        $order_info = $DB->getRow("SELECT * FROM pre_order WHERE param=:address AND status=0", [
            ':address' => $address
        ]);
        
        if (!$order_info) {
            error_log("WorldPay Webhook - No order found for address: " . $address);
            http_response_code(404);
            echo 'ORDER_NOT_FOUND';
            exit;
        }
        
        error_log("WorldPay Webhook - Found order: " . $order_info['trade_no']);
        
        // è·å–é€šé“é…ç½®ä¿¡æ¯
        $channel = \lib\Channel::get($order_info['channel']);
        if (!$channel) {
            error_log("WorldPay Webhook - No channel found");
            http_response_code(500);
            echo 'CHANNEL_ERROR';
            exit;
        }
        
        // éªŒè¯ç­¾å
        $signature = $_SERVER['HTTP_X_WEBHOOK_SIGNATURE'] ?? '';
        error_log("WorldPay Webhook - Signature: " . $signature);
        
        if (!self::verifyWebhookSignature($input, $signature)) {
            error_log("WorldPay Webhook - Signature verification failed");
            http_response_code(401);
            echo 'INVALID_SIGNATURE';
            exit;
        }
        
        // å¤„ç†å…¥è´¦é€šçŸ¥
        if ($data['networkType'] === 'tron' && $data['status'] === 'confirmed') {
            $amount = $data['amountReadable'];
            $tokenType = strtoupper($data['tokenType']);
            $txHash = $data['transactionHash'];
            
            error_log("WorldPay Webhook - Processing deposit: {$amount} {$tokenType}, TX: {$txHash}");
            
            // éªŒè¯é‡‘é¢å’Œå¸ç§
            if ($tokenType === 'USDT' && floatval($amount) >= floatval($order_info['money'])) {
                // æ ‡è®°è®¢å•ä¸ºå·²æ”¯ä»˜
                $DB->exec("UPDATE pre_order SET status=1, endtime=NOW(), api_trade_no=:txhash WHERE trade_no=:trade_no", [
                    ':txhash' => $txHash,
                    ':trade_no' => $order_info['trade_no']
                ]);
                
                // æ›´æ–°å•†æˆ·ä½™é¢
                $rate = floatval($order_info['money']) * (1 - floatval($conf['settle_rate']) / 100);
                $DB->exec("UPDATE pre_user SET money=money+:money WHERE uid=:uid", [
                    ':money' => $rate,
                    ':uid' => $order_info['uid']
                ]);
                
                // å‘é€å¼‚æ­¥é€šçŸ¥ç»™å•†æˆ·
                if ($order_info['notify_url']) {
                    self::sendNotifyToMerchant($order_info);
                }
                
                error_log("WorldPay Webhook - Payment processed successfully");
                
                // ç›´æ¥è¾“å‡ºæˆåŠŸå“åº”ç»™WorldPay
                http_response_code(200);
                echo 'OK';
                exit;
            } else {
                error_log("WorldPay Webhook - Amount or token type mismatch. Expected: {$order_info['money']} USDT, Got: {$amount} {$tokenType}");
            }
        } else {
            error_log("WorldPay Webhook - Not a TRON USDT deposit: " . json_encode($data));
        }
        
        // è¿”å›å¤±è´¥å“åº”
        error_log("WorldPay Webhook - Processing failed");
        http_response_code(400);
        echo 'FAIL';
        exit;
    }

    /**
     * åˆ›å»ºTRXé’±åŒ…åœ°å€
     */
    static private function createTRXWallet() {
        global $channel;
        
        $appId = $channel['appid'];
        $secretKey = $channel['appsecret'];
        $apiUrl = $channel['appurl'] ?: 'https://admin.worldpay.im/client-api';
        
        $timestamp = (string)(time() * 1000); // æ¯«ç§’æ—¶é—´æˆ³ï¼Œè½¬ä¸ºå­—ç¬¦ä¸²
        $nonce = self::generateNonce();
        
        // æ„å»ºè¯·æ±‚å‚æ•°ï¼ˆåŒ…å«è¯·æ±‚ä½“å‚æ•°ï¼‰
        $params = [
            'networkType' => 'TRON',
            'timestamp' => $timestamp,
            'nonce' => $nonce
        ];
        
        // ç”Ÿæˆç­¾å
        $signature = self::generateSignature($params, $secretKey);
        
        // æ„å»ºè¯·æ±‚å¤´
        $headers = [
            'Content-Type: application/json',
            'x-app-id: ' . $appId,
            'x-timestamp: ' . $timestamp,
            'x-nonce: ' . $nonce,
            'x-signature: ' . $signature
        ];
        
        // å‘é€è¯·æ±‚
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $apiUrl . '/wallets');
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode(['networkType' => 'TRON']));
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 30);
        
        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        $curlError = curl_error($ch);
        curl_close($ch);
        
        // è®°å½•è°ƒè¯•ä¿¡æ¯
        error_log("WorldPay API Request - URL: " . $apiUrl . '/wallets');
        error_log("WorldPay API Request - Headers: " . json_encode($headers));
        error_log("WorldPay API Request - Body: " . json_encode(['network' => 'TRON']));
        error_log("WorldPay API Response - HTTP Code: " . $httpCode);
        error_log("WorldPay API Response - Body: " . $response);
        
        if ($curlError) {
            throw new Exception('CURLé”™è¯¯: ' . $curlError);
        }
        
        if ($httpCode !== 200 && $httpCode !== 201) {
            $errorMsg = 'APIè¯·æ±‚å¤±è´¥: HTTP ' . $httpCode;
            if ($response) {
                $errorData = json_decode($response, true);
                if ($errorData && isset($errorData['message'])) {
                    $errorMsg .= ' - ' . $errorData['message'];
                }
            }
            throw new Exception($errorMsg);
        }
        
        $result = json_decode($response, true);
        
        if (!$result) {
            throw new Exception('åˆ›å»ºé’±åŒ…å¤±è´¥: æ— æ³•è§£æå“åº”æ•°æ® - ' . $response);
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
        if (isset($result['code']) && $result['code'] !== 200) {
            throw new Exception('åˆ›å»ºé’±åŒ…å¤±è´¥: ' . ($result['message'] ?? 'APIè¿”å›é”™è¯¯'));
        }
        
        // æ£€æŸ¥æ˜¯å¦æœ‰é’±åŒ…åœ°å€æ•°æ®
        if (isset($result['wallets']) && is_array($result['wallets']) && count($result['wallets']) > 0) {
            // è¿”å›ç¬¬ä¸€ä¸ªé’±åŒ…åœ°å€ä¿¡æ¯
            return $result['wallets'][0];
        } elseif (isset($result['data']) && is_array($result['data']) && count($result['data']) > 0) {
            // å¤‡ç”¨ï¼šæ£€æŸ¥dataå­—æ®µ
            return $result['data'][0];
        } elseif (isset($result['address'])) {
            // ç›´æ¥è¿”å›åœ°å€ä¿¡æ¯
            return ['address' => $result['address']];
        } else {
            throw new Exception('åˆ›å»ºé’±åŒ…å¤±è´¥: å“åº”ä¸­æœªæ‰¾åˆ°é’±åŒ…åœ°å€ - ' . $response);
        }
    }

    /**
     * ç”Ÿæˆç­¾å
     */
    static private function generateSignature($params, $secretKey) {
        // æŒ‰é”®åæ’åº
        ksort($params);
        
        // æ„å»ºç­¾åå­—ç¬¦ä¸²
        $canonicalString = '';
        foreach ($params as $key => $value) {
            $canonicalString .= $key . '=' . $value . '&';
        }
        $canonicalString = rtrim($canonicalString, '&');
        
        // è®¡ç®—HMAC-SHA256
        return hash_hmac('sha256', $canonicalString, $secretKey);
    }

    /**
     * éªŒè¯Webhookç­¾å
     */
    static private function verifyWebhookSignature($payload, $signature) {
        global $channel;
        
        $secretKey = $channel['appsecret'];
        $expectedSignature = hash_hmac('sha256', $payload, $secretKey);
        
        return hash_equals($expectedSignature, $signature);
    }

    /**
     * ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
     */
    static private function generateNonce() {
        return bin2hex(random_bytes(16));
    }

    /**
     * å‘é€é€šçŸ¥ç»™å•†æˆ·
     */
    static private function sendNotifyToMerchant($order) {
        global $DB;
        
        $notify_data = [
            'pid' => $order['uid'],
            'trade_no' => $order['trade_no'],
            'out_trade_no' => $order['out_trade_no'],
            'type' => $order['type'],
            'name' => $order['name'],
            'money' => $order['money'],
            'trade_status' => 'TRADE_SUCCESS'
        ];
        
        // è·å–å•†æˆ·å¯†é’¥ç”Ÿæˆç­¾å
        $userrow = $DB->getRow("SELECT `key` FROM pre_user WHERE uid=:uid", [':uid' => $order['uid']]);
        if ($userrow) {
            // æŒ‰ç…§ç³»ç»Ÿæ ‡å‡†ç”Ÿæˆç­¾å
            ksort($notify_data);
            $sign_str = '';
            foreach ($notify_data as $key => $value) {
                $sign_str .= $key . '=' . $value . '&';
            }
            $sign_str .= 'key=' . $userrow['key'];
            $notify_data['sign'] = md5($sign_str);
            
            // å¼‚æ­¥å‘é€é€šçŸ¥
            self::sendAsyncNotify($order['notify_url'], $notify_data);
        }
    }

    /**
     * å¼‚æ­¥å‘é€é€šçŸ¥
     */
    static private function sendAsyncNotify($url, $data) {
        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data));
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_TIMEOUT, 10);
        curl_exec($ch);
        curl_close($ch);
    }
}
